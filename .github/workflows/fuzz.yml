name: Fuzzing Pipeline

on:
  workflow_dispatch:
    inputs:
      fuzz_timeout:
        description: "Max fuzzing time (e.g. 30s, 5m, 0 = unlimited)"
        default: "30s"
        required: false
  push:
    branches: [ main ]

jobs:
  fuzz:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        target: [png_parser, xxd, tinyxml2_700]

    env:
      OUT_DIR: out/default

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Install AFL++ and libpng
      run: |
        sudo apt-get update
        sudo apt-get install -y afl++ libpng-dev

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ build â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Build target (ASan)
      shell: bash
      run: |
        export CC=afl-clang-fast
        export CXX=afl-clang-fast++
        CFLAGS="-g -O2 -fsanitize=address -fno-omit-frame-pointer"

        case "${{ matrix.target }}" in
          png_parser)
            mkdir -p targets/png_parser/build
            ${CC} ${CFLAGS} targets/png_parser/src/pngparse.c \
                  -o targets/png_parser/build/pngparse -lpng -lz
            ;;
          xxd)
            mkdir -p targets/xxd/build
            ${CC} ${CFLAGS} targets/xxd/src/xxd.c \
                  -o targets/xxd/build/xxd
            ;;
          tinyxml2_700)
            targets/tinyxml2_700/build.sh
            ;;
        esac

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ fuzz â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Run AFL++
      shell: bash
      env:
        TIMEOUT: ${{ github.event.inputs.fuzz_timeout || '30s' }}
        AFL_I_DONT_CARE_ABOUT_MISSING_CRASHES: 1
      run: |
        TARGET="${{ matrix.target }}"
        mkdir -p ${OUT_DIR}

        case "$TARGET" in
          png_parser)
            BIN=targets/png_parser/build/pngparse
            CORP=targets/png_parser/corpus
            ;;
          xxd)
            BIN=targets/xxd/build/xxd
            CORP=targets/xxd/corpus
            ;;
          tinyxml2_700)
            BIN=targets/tinyxml2_700/build/xmltest
            CORP=targets/tinyxml2_700/corpus
            ;;
        esac

        if [ "$TIMEOUT" = "0" ]; then
          afl-fuzz -i "$CORP" -o ${OUT_DIR} -- "$BIN" @@
        else
          timeout "$TIMEOUT" afl-fuzz -i "$CORP" -o ${OUT_DIR} -- "$BIN" @@ \
            || [ $? = 124 ]
        fi

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ package â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Package crashes
      id: pkg
      shell: bash
      run: |
        if compgen -G '${OUT_DIR}/crashes/id:*' > /dev/null; then
          tar -czf crashes-${{ matrix.target }}.tar.gz -C ${OUT_DIR} crashes
          echo "has_crash=true" >> "$GITHUB_OUTPUT"
        else
          echo "has_crash=false" >> "$GITHUB_OUTPUT"
        fi

    - name: Upload artefact
      if: steps.pkg.outputs.has_crash == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: crashes-${{ matrix.target }}
        path: crashes-${{ matrix.target }}.tar.gz

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ symbolize & Issue â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Symbolize & create Issue
      if: steps.pkg.outputs.has_crash == 'true'
      shell: bash
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        tar -xzf crashes-${{ matrix.target }}.tar.gz -C .
        case "${{ matrix.target }}" in
          png_parser)    BIN=targets/png_parser/build/pngparse ;;
          xxd)           BIN=targets/xxd/build/xxd ;;
          tinyxml2_700)  BIN=targets/tinyxml2_700/build/xmltest ;;
        esac

        for f in crashes/id:*; do
          out=$(mktemp)
          ASAN_SYMBOLIZER_PATH=$(which llvm-symbolizer) \
          ASAN_OPTIONS=symbolize=1:detect_leaks=0 \
          "$BIN" "$f" 2>&1 | tee "$out" >/dev/null || true

          title=$(grep -m1 -v '^$' "$out" | cut -c1-120)
          [ -z "$title" ] && title="ASan crash"
          title="Crash: ${title} [${{ matrix.target }}]"

          gh issue create \
            --title "$title" \
            --label auto-crash \
            --body "$(printf '### ðŸ’¥ Crash in **%s**\n\n**Input**: `%s`\n\n```text\n%s\n```' "${{ matrix.target }}" "$(basename "$f")" "$(cat "$out")")"
        done
